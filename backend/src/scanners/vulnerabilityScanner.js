import axios from 'axios';
import retire from 'retire';
import { JSDOM } from 'jsdom';
import { URL } from 'url';

export const analyzeVulnerabilities = async (url) => {
  const response = await axios.get(url, {
    validateStatus: () => true,
    timeout: 10000,
    headers: {
      'User-Agent':
        'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0',
    },
  });

  const dom = new JSDOM(response.data);
  const scripts = dom.window.document.querySelectorAll('script');
  const retireResults = [];

  for (const script of scripts) {
    if (script.src) {
      try {
        const scriptUrl = new URL(script.src, url).href;
        const scriptResponse = await axios.get(scriptUrl, { timeout: 5000 });
        const results = retire.scan(scriptUrl, scriptResponse.data);
        if (results.length > 0) {
          retireResults.push(...results);
        }
      } catch (e) {
        // ignore script download errors
      }
    } else {
      const results = retire.scan('inline', script.textContent);
      if (results.length > 0) {
        retireResults.push(...results);
      }
    }
  }

  return retireResults;
};
